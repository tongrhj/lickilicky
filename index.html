<!DOCTYPE html>
<title>lickilicky</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<meta name="robots" content="noindex">
<link rel="apple-touch-icon" href="assets/lickilicky.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<style>
body{
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  text-align: center;
  cursor: default;
  padding: 0 0 2em;
  margin: 0;
}
header,
footer{
  padding: 0 1em;
}
header{
  margin: 10px;
}
header > div{
  display: inline-flex;
  text-align: center;
  vertical-align: top;
  align-items: stretch;
  flex-grow: 1;
  flex-shrink: 1;
  flex-basis: 200px;
  box-sizing: border-box;
  padding: 0 10px;
}
#list{
  margin: 20px 1em;
  padding: 0;
  list-style: none;
  text-align: center;
  display: flex;
  flex-wrap: wrap;
}
#list li{
  display: inline-flex;
  text-align: center;
  vertical-align: top;
  flex-grow: 1;
  flex-shrink: 1;
  flex-basis: 120px;
  align-items: stretch;
  box-sizing: border-box;
}
#list li.unavailable{
  flex-direction: column;
  align-items: center;
  opacity: .35;
  padding: 5px 10px;
}
#list li.unavailable *{
  pointer-events: none;
}
#list li a{
  width: 100%;
  display: block;
  color: inherit;
  text-decoration: none;
  border-radius: 5px;
  transition: background-color .3s;
  padding: 5px 10px;
}
#list li a *{
  pointer-events: none;
}
#list li h2{
  font-size: 1em;
  margin: 0;
  padding: 0;
}
#controls{
  border-top: 1px solid #eee;
  position: fixed;
  bottom: 0;
  right: 0;
  left: 0;
  padding: 10px;
  background-color: rgba(255, 255, 255, .5);
  vertical-align: middle;
  -webkit-backdrop-filter: blur(5px);
  backdrop-filter: blur(5px);
}
@supports (not (backdrop-filter: blur(5px))) and (not (-webkit-backdrop-filter: blur(5px))) {
  #controls {
    background-color: rgba(255, 255, 255, .9);
  }
}
#controls input{
  vertical-align: middle;
}
.button{
	text-decoration:none;
	color:#333333;
	font-size:smaller;
	padding:0 15px;
	line-height:24px;
	height: auto;
	display:inline-block;
	text-align:center;
	background-color:#DDDDDD;
}
.button.pill{
  -webkit-border-radius: 16px;
  -moz-border-radius: 16px;
  border-radius: 16px;
}
.button.green{
	background-color:#4BC94D;
}
.button.red{
	background-color:#E53C38;
}
.muted{
  color:gray;
}
</style>
<header>
  <div>Active Merchants: <span id="count"></span></div>
  <div>Last Updated: <span id="last-updated-date">22 July 2018</span></div>
</header>

<ul id="list"></ul>

<div id="controls">
  <label id="nearby" hidden><input type="radio" name="sort" value="nearby" checked>Nearby</label>
  <label><input type="radio" name="sort" value="name">Name</label>
  <label><input type="radio" name="sort" value="price">Price</label>
  <label><input type="radio" name="sort" value="new">New</label>
  <label><input type="radio" name="sort" value="removed">Removed</label>
</div>

<footer>
  <img src="assets/lickilicky.png" alt="lickilicky" width="31" height="33" />
  <p>Burpple Beyond data is extracted from public information from <a href="https://www.burpple.com/search/sg?q=Beyond">official Burpple Beyond website</a>. All Burpple Beyond content is © Burpple. Lickilicky is © The Pokémon Company.</p>
  <p>lickilicky is not affiliated with any of the establishments listed or Burpple in any way.</p>
</footer>

<script>
var $list = document.getElementById('list');
var $count = document.getElementById('count');
var xhr = new XMLHttpRequest();
var data;
var rawData;
var activeViewFn;
var nearbyListCache;
xhr.onload = function(){
  rawData = JSON.parse(this.responseText);
  data = rawData.filter(filterFuncs['active'])
  renderList();
  updateCount();
};
xhr.open('GET', 'data/venues.min.json');
xhr.send();
var current = {}
var sortFuncs = {
  name: function(a, b) {
    if (a.name > b.name) {
      return 1
    } else if (a.name < b.name) {
      return -1
    } else {
      return 0
    }
  },
  price: function(a,b) {
    function extractPrice(formatted_price) {
      var price = (formatted_price && formatted_price.match(/\d/g).join('')) || 0
      return parseInt(price, 10)
    }
    return extractPrice(a.formatted_price) - extractPrice(b.formatted_price)
  },
  nearby: function(a,b) {
    function haversineDistance(p1, p2) {
      var atan2 = Math.atan2
      var cos = Math.cos
      var sin = Math.sin
      var sqrt = Math.sqrt
      var PI = Math.PI
      var R = 6378137 // (mean) radius of Earth (meters)

      function squared(x) { return x * x }
      function toRad(x) { return x * PI / 180.0 }
      var aLat = p1.latitude
      var bLat = p2.latitude
      var aLng = p1.longitude
      var bLng = p2.longitude

      var dLat = toRad(bLat - aLat)
      var dLon = toRad(bLng - aLng)

      var f = squared(sin(dLat / 2.0)) + cos(toRad(aLat)) * cos(toRad(bLat)) * squared(sin(dLon / 2.0))
      var c = 2 * atan2(sqrt(f), sqrt(1 - f))

      return R * c
    }
    var origin = {latitude: current.coords.latitude, longitude: current.coords.longitude}
    return haversineDistance(origin,a.location) - haversineDistance(origin,b.location)
  }
};
var filterFuncs = {
  new: function(a) {
    return a.newly_added
  },
  knownPriceRange: function(a) {
    return a.formatted_price
  },
  active: function(a) {
    return !a.removed
  },
  removed: function(a) {
    return a.removed
  }
}
function renderListItem(d) {
  var name = d.name;
  if (!name) return '';

  var prettyRemovalDate;
  if (d.removed && d.time_last_removed) {
    prettyRemovalDate = new Date(d.time_last_removed)
    prettyRemovalDate = prettyRemovalDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: '2-digit' })
  }

  return (d.removed ? '<li class="unavailable">' : '<li class="available">')
    + '<a href="https://www.burpple.com/search/sg?q=' + d.name + '" title="' + d.name + '" target="_blank" rel="noopener noreferrer" ontouchstart>'
      + '<h2>' + d.name + '</h2>'
      + (d.formatted_price ? '<small>' + d.formatted_price + '</small>' : '')
      + '<br><small class="muted">' + d.location.neighbourhood + '</small>'
      + (d.newly_added ? '<br><div class="button pill green">new</div>' : '')
      + (prettyRemovalDate ? ('<br><div class="button pill red">' + prettyRemovalDate + '</div>') : '')
    + '</a>'
  + '</li>';
}
function renderList(fn) {
  if (!rawData || !data) return;
  if (!fn && ('geolocation' in navigator)) {
    fn = 'nearby';
  } else if (!fn) {
    fn = 'name';
  }
  var content = ''
  if (['name', 'price'].includes(fn)) {
    content = data.sort(sortFuncs[fn]);
    if (fn === 'price') {
      content = content.filter(filterFuncs['knownPriceRange']);
    }
    $list.innerHTML = content.map(renderListItem).join('');
  } else if (fn === 'nearby') {
    // beware here be async !!
    if (nearbyListCache) {
      $list.innerHTML = nearbyListCache;
    } else {
      $list.innerHTML = '<marquee style="width:100%;">loading...</marquee>';
      navigator.geolocation.getCurrentPosition(function(position) {
        // success callback function
        if (activeViewFn !== 'nearby') {
          current = position;
          content = data.sort(sortFuncs[fn]);
          // deliberately do nothing to front-end
          nearbyListCache = content.map(renderListItem).join('');
        } else {
          current = position;
          nearbyListCache = data.sort(sortFuncs[fn]).map(renderListItem).join('');
          $list.innerHTML = nearbyListCache;
        };
      }, function(err){$list.innerHTML = err.message}, {timeout:10000});
    };
  } else if (fn === 'removed') {
    content = rawData.filter(filterFuncs[fn]);
    $list.innerHTML = content.map(renderListItem).join('');
  } else {
    content = data.filter(filterFuncs[fn])
    $list.innerHTML = content.map(renderListItem).join('');
  }
};
function updateCount() {
  if (!data) return;
  $count.innerText = '' + data.length;
}
var $controls = document.getElementById('controls');
$controls.addEventListener('change', function(e){
  activeViewFn = e.target.value;
  renderList(activeViewFn);
}, true);
if ('geolocation' in navigator) {
  document.getElementById('nearby').removeAttribute('hidden');
}
</script>
